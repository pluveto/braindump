---
aliases:
- 2PC
- 二阶段提交协议
---

2PC（Two-Phase Commit）协议是一种用于分布式系统中实现事务一致性的协议。在分布式系统中，多个节点（也称为参与者或代理）协同工作来执行一个事务，2PC协议确保所有参与者要么都成功执行事务，要么都放弃执行事务，从而保证系统的一致性。

## 假设

2PC协议基于以下假设：

1. 可靠的通信：假设在参与者和协调者之间存在可靠的通信渠道，消息可以安全地传递，并且不会出现丢失、乱序或重复的情况。

2. 可靠的参与者：假设所有的参与者都是可靠的，它们能够按照协议的要求执行事务，并且能够正常地响应协调者的请求。

3. 决策的最终性：假设一旦协调者发送了提交或放弃请求，所有的参与者都会按照该请求执行，并且无法撤销已经执行的操作。也就是说，假设在提交阶段的决策是最终的，不会出现部分提交的情况。

4. 单点协调者：2PC协议假设存在一个中心化的协调者，负责协调所有参与者的操作，并作出最终的决策。这也意味着如果协调者发生故障，整个协议将无法继续执行。

## 过程

2PC协议包含两个阶段：

1. 准备阶段（Prepare Phase）：
   - 协调者（Coordinator）向所有参与者发送准备请求，并等待它们的响应。
   - 参与者接收到准备请求后，执行预先操作，并将结果保存为“准备就绪”状态。
   - 这一阶段如果任意参与者失败，协调者将在最终阶段（提交阶段）发送回滚请求，要求所有参与者回滚之前的操作。

2. 提交阶段（Commit Phase）：
   - 协调者根据准备阶段的响应情况决定是提交还是放弃事务。
   - 如果所有参与者都返回准备就绪的响应，协调者将发送一个提交请求给所有参与者。
   - 参与者接收到提交请求后，执行事务的最终提交操作，并释放相关资源。完成后，它将返回一个提交完成的响应给协调者。
   - 如果任何一个参与者返回放弃的响应，协调者将发送一个放弃请求给所有参与者，要求它们回滚之前的操作。

如果第一阶段或者第二阶段回滚失败呢？

让我们分别讨论这两种情况：

1. 第一阶段回滚失败：  
    如果在准备阶段的某个参与者返回放弃响应后，协调者发送回滚请求给所有参与者，但其中一个或多个参与者无法成功回滚操作，可能会导致数据不一致。在这种情况下，已经放弃的参与者可能继续执行事务操作，而其他参与者已经回滚。这将导致数据的部分提交和部分回滚，破坏了事务的一致性。
    
2. 第二阶段回滚失败：  
    在提交阶段，如果协调者发送回滚请求给所有参与者，但其中一个或多个参与者由于故障或其他原因无法成功回滚操作，同样可能导致数据不一致。在这种情况下，已经成功提交的参与者可能无法撤销其操作，而其他参与者已经回滚。这将导致数据的部分提交和部分回滚，同样破坏了事务的一致性。


2PC 协议的关键是协调者的决策过程。如果协调者在准备阶段接收到所有参与者的准备就绪响应，它将发送提交请求，否则，它将发送放弃请求。这样可以确保所有参与者都按照相同的结果执行事务，从而保持一致性。

然而，2PC协议也存在一些问题：
- 阻塞：在协调者崩溃或网络故障的情况下，整个系统可能被阻塞，无法进行进一步的事务操作。
- 单点故障：协调者作为中心化的决策实体，其崩溃将导致整个协议的失败。没有备份协调者的情况下，系统的可用性会受到影响。
- 同步等待：在准备阶段和提交阶段，参与者需要等待其他参与者的响应，这可能导致性能下降。
- 数据不一致：尽管2PC协议可以保证事务的一致性，但在某些故障情况下，可能会出现数据不一致的情况，例如网络分区或参与者崩溃。

为了解决2PC协议的一些问题，出现了一些改进的协议，如3PC（Three-Phase Commit）和Paxos。这些协议在2PC的基础上引入了更复杂的协调机制，以提高系统的可用性和性能。